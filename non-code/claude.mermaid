sequenceDiagram
    participant Client
    participant Controller as AgentController
    participant AgentService
    participant Agent as BaseAgent
    participant Capabilities as Agent Capabilities
    participant MessageBus
    participant MemoryService
    participant ExternalServices as External Services (LLM, etc.)

    Client->>Controller: Submit Task Request
    Controller->>AgentService: createTask(request)

    AgentService->>AgentService: validateRequest()
    AgentService->>Agent: findSuitableAgent(taskType)

    AgentService->>MessageBus: publish(TaskMessage)
    Note over MessageBus: Routes message to appropriate agent

    MessageBus->>Agent: processMessage(TaskMessage)

    Agent->>MemoryService: storeMessage(agentId, message)
    Agent->>Agent: createExecutionContext(message)

    Agent->>Agent: findCapabilityForMessage(message)
    Agent->>Agent: createTaskFromMessage(message)

    Agent->>Capabilities: execute(task, context)

    alt External Service Required
        Capabilities->>ExternalServices: callExternalService(params)
        ExternalServices-->>Capabilities: serviceResponse
    end

    Capabilities-->>Agent: TaskResult

    Agent->>Agent: handleTaskResult(result, originalMessage)

    alt Has Response
        Agent->>MessageBus: publish(ResponseMessage)
        MessageBus-->>AgentService: deliver(ResponseMessage)
        AgentService-->>Controller: TaskResponse
        Controller-->>Client: Return Response
    end

    Agent->>MemoryService: updateMemory(taskResult)

    alt Task Requires Further Processing
        Agent->>MessageBus: publish(SubtaskMessage)
        Note over MessageBus: Creates additional task flow
    end
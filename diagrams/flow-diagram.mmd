sequenceDiagram
    participant Client
    participant AgentService
    participant AgentExecutor
    participant MCPContext
    participant StepExecutor
    participant StepManager
    participant ModelCallExecutorFactory
    participant ToolCallExecutorFactory
    participant ModelCallExecutor
    participant ToolCallExecutor
    participant MCPChatMemory

    Client->>AgentService: runAgent(recipeId, userMessage)
    AgentService->>MCPContext: createAgentContext(recipe)
    AgentService->>AgentExecutor: new AgentExecutor(agent, context)
    AgentExecutor->>StepManager: getCurrentStep()
    loop Steps
        AgentExecutor->>StepExecutor: new StepExecutor(currentStep, context)
        StepExecutor->>ModelCallExecutorFactory: forProvider(provider, modelCall, context)
        ModelCallExecutorFactory->>ModelCallExecutor: create ModelCallExecutor
        ModelCallExecutor->>MCPChatMemory: findByConversationId(conversationId)
        ModelCallExecutor->>ModelCallExecutor: build prompt
        ModelCallExecutor->>ModelCallExecutor: call model
        ModelCallExecutor->>MCPChatMemory: saveChatResponse(conversationId, response)
        ModelCallExecutor->>StepExecutor: return MCPModelCallResponse
        StepExecutor->>ToolCallExecutorFactory: forProvider(provider, toolCall, context)
        ToolCallExecutorFactory->>ToolCallExecutor: create ToolCallExecutor
        ToolCallExecutor->>MCPChatMemory: findByConversationId(conversationId)
        ToolCallExecutor->>ToolCallExecutor: execute tool call
        ToolCallExecutor->>MCPChatMemory: saveAll(conversationId, toolResult)
        StepExecutor->>StepManager: advanceToNextStep()
        StepManager->>AgentExecutor: getCurrentStep()
    end
    AgentExecutor->>AgentService: return AgentResult
    AgentService->>Client: return AgentResult